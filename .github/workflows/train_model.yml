name: Train Model

on: 
  push:
    branches:
      - main

jobs:
  experiment:
    name: Train Model in Development
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.8'

    - name: Downgrade pip
      run: |
        python -m pip install --upgrade pip==23.0.1

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Train model in development environment
      run: |
        az ml job create --file jobs/train.yml --set defaults.environment=development \
          --inputs data_folder=azureml:diabetes-dev-folder --stream

    - name: Check job status
      id: check_experiment_status
      run: |
        job_id=$(az ml job create --file jobs/train.yml --set defaults.environment=development \
          --inputs data_folder=azureml:diabetes-dev-folder --query id -o tsv --stream)
        echo "experiment_job_id=$job_id" >> $GITHUB_ENV

  production:
    name: Train Model in Production
    runs-on: ubuntu-latest
    needs: experiment
    if: success()  # Only run if experiment job is successful

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.8'

    - name: Downgrade pip
      run: |
        python -m pip install --upgrade pip==23.0.1

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Train model in production environment
      run: |
        az ml job create --file jobs/train.yml --set defaults.environment=production \
          --inputs data_folder=azureml:diabetes-prod-folder --stream

    - name: Check job status
      id: check_production_status
      run: |
        job_id=$(az ml job create --file jobs/train.yml --set defaults.environment=production \
          --inputs data_folder=azureml:diabetes-prod-folder --query id -o tsv --stream)
        echo "production_job_id=$job_id" >> $GITHUB_ENV
